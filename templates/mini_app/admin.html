{% extends "mini_app/base.html" %}

{% block title %}–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å - NFT Gifts Market{% endblock %}

{% block content %}
<div class="card">
    <h2 style="margin-bottom: 16px; color: #dc3545;">üîß –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h2>
    <p style="color: var(--tg-theme-hint-color); font-size: 14px;">
        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –ø–æ UID, –±–∞–ª–∞–Ω—Å–∞–º–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    </p>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="card">
    <h3 style="margin-bottom: 12px;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
    <div id="statsContainer">
        <div class="text-center" style="padding: 20px; color: var(--tg-theme-hint-color);">
            ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...
        </div>
    </div>
</div>

<!-- –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ UID -->
<div class="card">
    <h3 style="margin-bottom: 12px;">üí∞ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ UID</h3>
    
    <div class="form-group">
        <label class="form-label">üÜî UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
        <input type="text" id="userUID" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: LARGYRST" maxlength="8" style="text-transform: uppercase;">
    </div>
    
    <div class="form-group">
        <label class="form-label">‚≠ê –ó–≤–µ–∑–¥—ã:</label>
        <input type="number" id="starsAmount" class="form-control" placeholder="0" min="0">
    </div>
    
    <div class="form-group">
        <label class="form-label">‚ÇΩ –†—É–±–ª–∏:</label>
        <input type="number" id="rubAmount" class="form-control" placeholder="0" min="0" step="0.01">
    </div>
    
    <button class="btn" onclick="addBalanceByUID()">
        üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å
    </button>
    
    <div id="balanceResult" style="margin-top: 12px;"></div>
</div>

<!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
<div class="card">
    <h3 style="margin-bottom: 12px;">üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
    
    <button class="btn btn-secondary" onclick="loadAllUsers()">
        üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    </button>
    
    <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div id="usersContainer" style="margin-top: 16px;">
        <div class="text-center" style="padding: 20px; color: var(--tg-theme-hint-color);">
            üëÜ –ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞
        </div>
    </div>
</div>

<!-- –ù–∞–∫—Ä—É—Ç–∫–∞ —Å–¥–µ–ª–æ–∫ –ø–æ UID -->
<div class="card">
    <h3 style="margin-bottom: 12px;">üìà –ù–∞–∫—Ä—É—Ç–∫–∞ —Å–¥–µ–ª–æ–∫ –ø–æ UID</h3>
    
    <div class="form-group">
        <label class="form-label">üÜî UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
        <input type="text" id="dealsUID" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: LARGYRST" maxlength="8" style="text-transform: uppercase;">
    </div>
    
    <div class="form-group">
        <label class="form-label">ü§ù –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫:</label>
        <input type="number" id="dealsCount" class="form-control" placeholder="0" min="0">
        <small style="color: var(--tg-theme-hint-color);">
            –£–∫–∞–∂–∏—Ç–µ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫ (–Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —Ç–µ–∫—É—â–µ–º—É, –∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è)
        </small>
    </div>
    
    <button class="btn" onclick="updateDealsCount()" style="background: #ffc107; color: #000;">
        üìà –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫
    </button>
    
    <div id="dealsResult" style="margin-top: 12px;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º UID –≤ –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
    document.getElementById('userUID').addEventListener('input', function(e) {
        e.target.value = e.target.value.toUpperCase();
    });
    
    document.getElementById('dealsUID').addEventListener('input', function(e) {
        e.target.value = e.target.value.toUpperCase();
    });
});

function loadStats() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    fetch('/api/admin/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.stats;
                document.getElementById('statsContainer').innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div style="text-align: center; padding: 12px; background: var(--tg-theme-bg-color); border-radius: 8px; border: 1px solid var(--tg-theme-hint-color);">
                            <div style="font-size: 20px; font-weight: bold; color: var(--tg-theme-link-color);">${stats.total_users}</div>
                            <div style="font-size: 12px; color: var(--tg-theme-hint-color);">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: var(--tg-theme-bg-color); border-radius: 8px; border: 1px solid var(--tg-theme-hint-color);">
                            <div style="font-size: 20px; font-weight: bold; color: #28a745;">${stats.verified_users}</div>
                            <div style="font-size: 12px; color: var(--tg-theme-hint-color);">–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: var(--tg-theme-bg-color); border-radius: 8px; border: 1px solid var(--tg-theme-hint-color);">
                            <div style="font-size: 20px; font-weight: bold; color: #ffc107;">‚≠ê ${stats.total_stars}</div>
                            <div style="font-size: 12px; color: var(--tg-theme-hint-color);">–í—Å–µ–≥–æ –∑–≤–µ–∑–¥</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: var(--tg-theme-bg-color); border-radius: 8px; border: 1px solid var(--tg-theme-hint-color);">
                            <div style="font-size: 20px; font-weight: bold; color: #28a745;">‚ÇΩ ${stats.total_rub}</div>
                            <div style="font-size: 12px; color: var(--tg-theme-hint-color);">–í—Å–µ–≥–æ —Ä—É–±–ª–µ–π</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: var(--tg-theme-bg-color); border-radius: 8px; border: 1px solid var(--tg-theme-hint-color);">
                            <div style="font-size: 20px; font-weight: bold; color: #7b1fa2;">${stats.total_deals}</div>
                            <div style="font-size: 12px; color: var(--tg-theme-hint-color);">–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</div>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('statsContainer').innerHTML = '<div class="alert alert-warning">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>';
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            document.getElementById('statsContainer').innerHTML = '<div class="alert alert-warning">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>';
        });
}

function addBalanceByUID() {
    const uid = document.getElementById('userUID').value.trim().toUpperCase();
    const stars = parseInt(document.getElementById('starsAmount').value) || 0;
    const rub = parseFloat(document.getElementById('rubAmount').value) || 0;
    
    if (!uid) {
        showResult('balanceResult', '–í–≤–µ–¥–∏—Ç–µ UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
        return;
    }
    
    if (uid.length !== 8) {
        showResult('balanceResult', 'UID –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 8 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
    }
    
    if (stars === 0 && rub === 0) {
        showResult('balanceResult', '–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è', 'error');
        return;
    }
    
    showResult('balanceResult', '–ü–æ–ø–æ–ª–Ω—è–µ–º –±–∞–ª–∞–Ω—Å...', 'info');
    
    fetch('/api/admin/add_balance', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            uid: uid,
            stars: stars,
            rub: rub
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResult('balanceResult', `‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –¥–ª—è ${data.user_info}`, 'success');
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('userUID').value = '';
            document.getElementById('starsAmount').value = '';
            document.getElementById('rubAmount').value = '';
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            loadStats();
        } else {
            showResult('balanceResult', `‚ùå ${data.message}`, 'error');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:', error);
        showResult('balanceResult', '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    });
}

function loadAllUsers() {
    document.getElementById('usersContainer').innerHTML = '<div class="text-center" style="padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>';
    
    fetch('/api/admin/users')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const users = data.users;
                let html = '';
                
                users.forEach(user => {
                    const verifiedBadge = user.verified ? '<span style="color: #28a745;">‚úÖ –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω</span>' : '<span style="color: #dc3545;">‚ùå –ù–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω</span>';
                    
                    html += `
                        <div style="border: 1px solid var(--tg-theme-hint-color); border-radius: 8px; padding: 12px; margin: 8px 0; background: var(--tg-theme-bg-color);">
                            <div style="font-weight: bold; margin-bottom: 4px;">
                                üÜî UID: ${user.uid} | üì± ID: ${user.telegram_id}
                            </div>
                            <div style="margin-bottom: 4px;">
                                üë§ ${user.first_name || '–ù–µ—Ç –∏–º–µ–Ω–∏'} ${user.username ? '@' + user.username : ''}
                            </div>
                            <div style="margin-bottom: 4px;">
                                üí∞ ‚≠ê${user.balance_stars} ‚ÇΩ${user.balance_rub} | üíº ${user.successful_deals} —Å–¥–µ–ª–æ–∫
                            </div>
                            <div style="font-size: 12px; color: var(--tg-theme-hint-color);">
                                ${verifiedBadge} | üìÖ ${new Date(user.created_at).toLocaleDateString()}
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('usersContainer').innerHTML = html || '<div class="text-center" style="padding: 20px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            } else {
                document.getElementById('usersContainer').innerHTML = '<div class="alert alert-warning">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
            document.getElementById('usersContainer').innerHTML = '<div class="alert alert-warning">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
        });
}

function showResult(elementId, message, type) {
    const element = document.getElementById(elementId);
    let className = 'alert ';
    
    switch(type) {
        case 'success':
            className += 'alert-success';
            break;
        case 'error':
            className += 'alert-danger';
            break;
        case 'info':
            className += 'alert-info';
            break;
        default:
            className += 'alert-info';
    }
    
    element.innerHTML = `<div class="${className}">${message}</div>`;
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
    if (type === 'success') {
        setTimeout(() => {
            element.innerHTML = '';
        }, 5000);
    }
}

function updateDealsCount() {
    const uid = document.getElementById('dealsUID').value.trim().toUpperCase();
    const dealsCount = parseInt(document.getElementById('dealsCount').value) || 0;
    
    if (!uid) {
        showResult('dealsResult', '–í–≤–µ–¥–∏—Ç–µ UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
        return;
    }
    
    if (uid.length !== 8) {
        showResult('dealsResult', 'UID –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 8 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
    }
    
    if (dealsCount < 0) {
        showResult('dealsResult', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º', 'error');
        return;
    }
    
    showResult('dealsResult', '–û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫...', 'info');
    
    fetch('/api/admin/update_deals_by_uid', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            uid: uid,
            deals_count: dealsCount
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResult('dealsResult', `‚úÖ ${data.message}`, 'success');
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('dealsUID').value = '';
            document.getElementById('dealsCount').value = '';
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            loadStats();
        } else {
            showResult('dealsResult', `‚ùå ${data.message}`, 'error');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–¥–µ–ª–æ–∫:', error);
        showResult('dealsResult', '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    });
}
</script>
{% endblock %}