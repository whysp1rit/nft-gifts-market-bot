{% extends "mini_app/base.html" %}

{% block title %}–ü—Ä–∏–≤—è–∑–∫–∞ UID - NFT Gifts Market{% endblock %}

{% block content %}
<div class="card">
    <h2 style="margin-bottom: 16px; color: #2481cc;">üîó –ü—Ä–∏–≤—è–∑–∫–∞ UID –∫ –∞–∫–∫–∞—É–Ω—Ç—É</h2>
    <p style="color: var(--tg-theme-hint-color); font-size: 14px;">
        –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å UID –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –∑–¥–µ—Å—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
    </p>
</div>

<div class="card">
    <h3 style="margin-bottom: 12px;">üÜî –í–≤–æ–¥ UID</h3>
    
    <div class="form-group">
        <label class="form-label">UID (8 —Å–∏–º–≤–æ–ª–æ–≤):</label>
        <input type="text" id="targetUID" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: UOPVGVSU" maxlength="8" style="text-transform: uppercase;">
        <small style="color: var(--tg-theme-hint-color);">
            UID –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–æ–≤–Ω–æ 8 —Å–∏–º–≤–æ–ª–æ–≤ (–±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã)
        </small>
    </div>
    
    <button class="btn" onclick="linkUID()">
        üîó –ü—Ä–∏–≤—è–∑–∞—Ç—å UID
    </button>
    
    <div id="linkResult" style="margin-top: 12px;"></div>
</div>

<div class="card">
    <h3 style="margin-bottom: 12px;">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
    <div style="font-size: 14px; color: var(--tg-theme-hint-color);">
        <p><strong>–ß—Ç–æ —Ç–∞–∫–æ–µ UID?</strong></p>
        <p>UID (Unique Identifier) - —ç—Ç–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π 8-—Å–∏–º–≤–æ–ª—å–Ω—ã–π –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–¥–∞–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–∞–≤ –≤ —Å–∏—Å—Ç–µ–º–µ.</p>
        
        <p style="margin-top: 12px;"><strong>–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å UID?</strong></p>
        <p>–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∞—à–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ UID.</p>
        
        <p style="margin-top: 12px;"><strong>–ß—Ç–æ –¥–∞–µ—Ç –ø—Ä–∏–≤—è–∑–∫–∞ UID?</strong></p>
        <p>‚Ä¢ –î–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏<br>
        ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏<br>
        ‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏<br>
        ‚Ä¢ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤</p>
    </div>
</div>

<div class="card" style="text-align: center;">
    <button class="btn btn-secondary" onclick="navigateTo('/')">
        üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º UID –≤ –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
    document.getElementById('targetUID').addEventListener('input', function(e) {
        e.target.value = e.target.value.toUpperCase();
    });
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ Telegram
    if (window.telegramWebApp) {
        window.telegramWebApp.MainButton.setText('–ü—Ä–∏–≤—è–∑–∞—Ç—å UID');
        window.telegramWebApp.MainButton.onClick(() => {
            linkUID();
        });
        window.telegramWebApp.MainButton.show();
    }
});

function linkUID() {
    const uid = document.getElementById('targetUID').value.trim().toUpperCase();
    
    if (!uid) {
        showResult('linkResult', '–í–≤–µ–¥–∏—Ç–µ UID', 'error');
        return;
    }
    
    if (uid.length !== 8) {
        showResult('linkResult', 'UID –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–æ–≤–Ω–æ 8 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
    }
    
    if (!window.telegramUser) {
        showResult('linkResult', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
        return;
    }
    
    showResult('linkResult', '–ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º UID –∫ –≤–∞—à–µ–º—É –∞–∫–∫–∞—É–Ω—Ç—É...', 'info');
    
    fetch('/api/link_uid', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            uid: uid,
            telegram_user: window.telegramUser
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResult('linkResult', `‚úÖ ${data.message}`, 'success');
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ
            document.getElementById('targetUID').value = '';
            
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                showResult('linkResult', 'üîÑ –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É...', 'info');
                setTimeout(() => {
                    window.location.href = '/';
                }, 1000);
            }, 2000);
            
        } else {
            showResult('linkResult', `‚ùå ${data.message}`, 'error');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ UID:', error);
        showResult('linkResult', '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    });
}

function showResult(elementId, message, type) {
    const element = document.getElementById(elementId);
    let className = 'alert ';
    
    switch(type) {
        case 'success':
            className += 'alert-success';
            break;
        case 'error':
            className += 'alert-warning';
            break;
        case 'info':
            className += 'alert-info';
            break;
        default:
            className += 'alert-info';
    }
    
    element.innerHTML = `<div class="${className}">${message}</div>`;
}
</script>
{% endblock %}